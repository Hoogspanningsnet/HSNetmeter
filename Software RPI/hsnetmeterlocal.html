<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://code.highcharts.com/stock/highstock.js"></script>
	<script src="https://code.highcharts.com/modules/boost.js"></script>
	<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
	<meta charset="utf-8" />
	<link rel="icon" href="favicon.ico">
	<title>Netfrequentie.nl - Grid frequency graph</title>
</head>
<body>
	<div id="container" style="width:100%; height:100%; margin: 0 auto;"></div>
	<script>
		$(document).ready(function () { 
			Highcharts.setOptions({
				global: { useUTC: false }
			});
			var chart = new Highcharts.stockChart('container', {
				boost: { useGPUTranslations: true },
				navigator: {
					enabled: true,
					yAxis: {
						plotLines: [{
							color: '#ccd6eb',
							value: 50,
							width: 1
						}]
					},
					series: { marker: { enabled: false } }
				},
				xAxis: {
					type: 'datetime',
					ordinal: false
				},
				yAxis: {
					labels: { format: '{value:.3f}' },
					plotBands:[ 
						{ // mark the lower problem zone
							color: '#FF3333',
							from: 45.000,
							to: 49.800,
						},
						{ // mark the upward dispatch high regulation zone
							color: '#ff6600',
							from: 49.800,
							to: 49.850,
						},
						{ // mark the upward dispatch highmid regulation zone
							color: '#ff9900',
							from: 49.850,
							to: 49.900,
						},
						{ // mark the upward dispatch lowmid regulation zone
							color: '#ffff00',
							from: 49.900,
							to: 49.950,
						},
						{ // mark the upward dispatch low regulation zone
							color: '#ccff66',
							from: 49.950,
							to: 49.980,
						},
						{ // mark the deadband
							color: '#99ff66',
							from: 49.980,
							to: 50.020,
						},
						{ // mark the donwqard dispatch low regulation zone
							color: '#ccff66',
							from: 50.020,
							to: 50.050,
						},
						{ // mark the upward dispatch lowmid regulation zone
							color: '#ffff00',
							from: 50.050,
							to: 50.100,
						},
						{ // mark the upward dispatch highmid regulation zone
							color: '#ff9900',
							from: 50.100,
							to: 50.150,
						},
						{ // mark the upward dispatch high regulation zone
							color: '#ff6600',
							from: 50.150,
							to: 50.200,
						},
						{ // mark the upper problem zone
							color: '#FF3333',
							from: 50.200,
							to: 55.000,
						},
					],
				},
				tooltip: {
					pointFormat: 'Frequency: {point.y:.3f} Hz',
				},
				series: [{
					name: 'Frequency',
					data: [],
					lineWidth: 2
				}],
				plotOptions: {
					line: { marker: { enabled: false } }
				},
				legend: { enabled: false },
				rangeSelector: {
					enabled: true,
					floating: true,
					buttonPosition: { x: 5, y: 5 },
					buttonTheme: { width: 40, height: 16 },
					buttons: [
						{ type: 'second', count: 15, text:   '15s' },
						{ type: 'second', count: 30, text:   '30s' },
						{ type: 'minute', count:  1, text:  '1min' },
						{ type: 'minute', count:  2, text:  '2min' },
						{ type: 'minute', count:  5, text:  '5min' },
						{ type: 'minute', count: 10, text: '10min' }
					]
				}
			});

			var buffer = [];
			const buffersize = 5;
			const socket = new WebSocket("ws://" + location.hostname + ":6789/");
			socket.onopen = function(event) { console.log("connected"); };
			socket.onmessage = function(event) {
				var data = JSON.parse(event.data);
				buffer.push([ data.tick * 1000, data.freq ]);
				if (buffer.length >= buffersize) {
					var series = chart.series[0];
					var shift = series.options.data.length > 10000;
					while (buffer.length > 0) {
						series.addPoint(buffer.shift(), buffer.length == 0, shift, false);
					}
				}
			};
			socket.onerror = function (event) { console.log("disconnected"); };
		});
	</script>
</body>
</html>
